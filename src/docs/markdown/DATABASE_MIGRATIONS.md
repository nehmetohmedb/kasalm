# Database Migrations Guide

## Overview

This guide covers how to work with database migrations in the Kasal project. We use Alembic, a database migration tool for SQLAlchemy, to manage schema changes to our database.

Migrations are essential for:
- Tracking database schema changes in version control
- Applying schema changes consistently across environments
- Rolling back database changes if needed
- Collaborating on database schema changes across the team

## Migration Structure

In our project, migrations are stored in the `backend/migrations` directory:

```
backend/
├── migrations/
│   ├── versions/       # Contains individual migration scripts
│   ├── env.py          # Alembic environment configuration
│   └── script.py.mako  # Template for migration scripts
└── alembic.ini         # Alembic configuration file
```

## Creating Migrations

### Automatic Migration Generation

For most schema changes, you can use Alembic's automatic migration generation. This works by comparing the state of your models with the state of the database, and generating the necessary SQL to bring the database in line with your models.

1. First, make changes to your SQLAlchemy models in the `src/models/` directory:
   ```python
   # Example: Adding a new column to an existing model
   class Agent(Base):
       # Existing fields...
       
       # New field
       result_as_answer = Column(Boolean, default=False)
   ```

2. Make sure your model is imported in `src/db/all_models.py` so Alembic can detect it.

3. Generate a migration script:
   ```bash
   cd backend
   alembic revision --autogenerate -m "Add result_as_answer to Agent model"
   ```

4. Review the generated migration script in `migrations/versions/` to ensure it will make the changes you expect. It's important to review the migration before applying it to catch any potential issues.

### Manual Migration Creation

Sometimes automatic migration generation might not capture all the changes correctly, or you might need more complex migrations. In these cases, you can create a manual migration:

```bash
cd backend
alembic revision -m "Custom migration description"
```

This will create an empty migration script that you can fill in with custom SQL commands using Alembic's operations API.

## Applying Migrations

To apply migrations and update your database schema:

```bash
cd backend
alembic upgrade head
```

This will apply all pending migrations to bring your database to the latest schema version.

### Specific Migration Targets

You can also:

- Upgrade to a specific migration:
  ```bash
  alembic upgrade <revision_id>
  ```

- Downgrade to a previous migration:
  ```bash
  alembic downgrade <revision_id>
  ```

- Upgrade or downgrade relative to current version:
  ```bash
  alembic upgrade +2   # Apply the next 2 migrations
  alembic downgrade -1  # Revert the most recent migration
  ```

## Real-World Example

Here's a complete example of adding a new field to an existing model:

1. Add the field to the model in `src/models/agent.py`:
   ```python
   class Agent(Base):
       # Existing fields...
       result_as_answer = Column(Boolean, default=False)
   ```

2. Generate a migration:
   ```bash
   cd backend
   alembic revision --autogenerate -m "Add result_as_answer to Agent model"
   ```

3. Review the generated migration file in `migrations/versions/`:
   ```python
   def upgrade() -> None:
       # ### commands auto generated by Alembic - please adjust! ###
       op.add_column('agents', sa.Column('result_as_answer', sa.Boolean(), nullable=True))
       # ### end Alembic commands ###

   def downgrade() -> None:
       # ### commands auto generated by Alembic - please adjust! ###
       op.drop_column('agents', 'result_as_answer')
       # ### end Alembic commands ###
   ```

4. Apply the migration:
   ```bash
   alembic upgrade head
   ```

5. Verify the change in your database:
   ```bash
   # Using psql
   psql -U your_user -d your_database -c "\d agents"
   ```

## Best Practices

1. **Always review generated migrations** before applying them. Auto-generation is not perfect and may miss certain details or include unwanted changes.

2. **Keep migrations small and focused** on specific changes to make them easier to review and revert if necessary.

3. **Test migrations** in a development environment before applying them to production.

4. **Include meaningful descriptions** in your migration names to make it clear what they do.

5. **Don't modify existing migration files** that have been applied to any environment. Create new migrations instead.

6. **Be careful with data migrations** that modify existing data. These should be thoroughly tested.

7. **Include default values** for new non-nullable columns, or add them as nullable first, then fill them with data, and finally alter them to be non-nullable in a subsequent migration.

8. **Create migrations for each model change** rather than making multiple model changes and then creating a single migration.

## Troubleshooting

### Common Issues

1. **Migration fails with "Target database is not up to date"**
   - Run `alembic current` to see the current revision
   - Run `alembic history` to see the migration history
   - You may need to manually fix the alembic_version table in your database

2. **Auto-generation is not detecting changes**
   - Ensure your models are imported in `src/db/all_models.py`
   - Check that the model is properly configured with `__tablename__`
   - Verify that the Base class is the same one imported in the Alembic environment

3. **"Can't locate revision identified by..."**
   - Ensure all migration files are properly committed to version control
   - Check that you have the latest version of the code with all migrations

4. **Migration directory doesn't exist**
   - Create the directory: `mkdir -p migrations/versions`

## Additional Resources

- [Alembic Documentation](https://alembic.sqlalchemy.org/en/latest/)
- [SQLAlchemy Documentation](https://docs.sqlalchemy.org/en/latest/) 